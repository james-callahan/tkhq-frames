apiVersion: v1
kind: ServiceAccount
metadata:
  name: frames
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frames
spec:
  template:
    spec:
      initContainers:
        - name: template-quorum-key
          image: ghcr.io/tkhq/frames
          envs:
            - name: TURNKEY_ENVIRONMENT_SIGNER_QUORUM_PUBLIC_KEY
              value: 123456
          command:
            - sh
            - -c
            - |
                envsubst ${TURNKEY_ENVIRONMENT_SIGNER_QUORUM_PUBLIC_KEY} < import/index.template.html > templated/import/index.html;
                envsubst ${TURNKEY_ENVIRONMENT_SIGNER_QUORUM_PUBLIC_KEY} < import/standalone.template.html > templated/import/standalone.html;
                envsubst ${TURNKEY_ENVIRONMENT_SIGNER_QUORUM_PUBLIC_KEY} < export/index.template.html > templated/export/index.html;
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
            runAsUser: 1000
          volumeMounts:
            - name: templated
              mountPath: /usr/share/nginx/templated
      containers:
        - name: frames
          image: ghcr.io/tkhq/frames
          ports:
            - name: auth
              containerPort: 8080
            - name: export
              containerPort: 8081
            - name: recovery
              containerPort: 8082
            - name: import
              containerPort: 8083
          livenessProbe:
            httpGet:
              path: /health
              port: auth
          resources:
            requests:
              memory: 5Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            runAsNonRoot: true
            runAsUser: 1000
          volumeMounts:
            - name: templated
              mountPath: /usr/share/nginx/templated
              readOnly: true
      serviceAccountName: frames
      volumes:
        - name: templated
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: frames
spec:
  ports:
    - name: http-auth
      port: 8080
      targetPort: auth
    - name: http-export
      port: 8081
      targetPort: export
    - name: http-recovery
      port: 8082
      targetPort: recovery
    - name: http-import
      port: 8083
      targetPort: import
